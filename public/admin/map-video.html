<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>üìå Map Files</title>
</head>

<body>
  <h1>üóÇÔ∏è Map Uploaded Files</h1>
  <div id="fileList">Loading files...</div>

  <script>
    let allFiles = [];

    async function loadFiles() {
      try {
        const response = await fetch('http://localhost:4000/api-v1/list');
        allFiles = await response.json();

        const fileList = document.getElementById('fileList');
        fileList.innerHTML = '';

        allFiles.forEach(file => {
          const div = document.createElement('div');

          div.innerHTML = `
            <strong>${file.title}</strong><br>
            ID: ${file.id}<br>
            Filename: ${file.filename}<br>
            Map URL: ${file.map_id ?? '‚Äî'}<br>
            <label>Map to (enter URL): 
              <input type="url" id="map-input-${file.id}" placeholder="Enter map URL" />
            </label>
            <button onclick="mapFile(${file.id})">üß© Map</button>
            <hr>
          `;

          fileList.appendChild(div);
        });
      } catch (err) {
        console.error("‚ùå Failed to load files:", err);
        document.getElementById('fileList').innerText = '‚ö†Ô∏è Failed to load files.';
      }
    }

    async function mapFile(fileId) {
      const input = document.getElementById(`map-input-${fileId}`);
      const mapUrl = input.value.trim();

      if (!mapUrl) {
        alert("‚ùå Please enter a map URL.");
        return;
      }

      try {
        const response = await fetch(`http://localhost:4000/api-v1/files/${fileId}/map`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ map_id: mapUrl }) // ‡∏™‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô string URL
        });

        const result = await response.json();

        if (response.ok) {
          alert('‚úÖ Mapping complete!');
          loadFiles(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
        } else {
          alert('‚ùå Error: ' + result.error);
        }
      } catch (err) {
        alert('‚ùå Failed to map: ' + err.message);
      }
    }

    loadFiles();
  </script>
</body>

</html>
